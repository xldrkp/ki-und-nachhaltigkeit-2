---
// @ts-ignore
import { parse } from 'node-html-parser';
// @ts-ignore
import * as linkify from 'linkifyjs';
// @ts-ignore
import linkifyHtml from 'linkify-html';
const options = { defaultProtocol: 'https' };
const { id } = Astro.props;

const api_base = 'https://api.zotero.org/';
const group_id = '5364207';
const params =
  '?format=json&linkwrap=1&include=data,bib&itemType=-note&locale=de&style=deutsche-gesellschaft-fur-psychologie&direction=asc&sort=creator';

const query_string =
  api_base + 'groups/' + group_id + '/collections/' + id + '/items' + params;

const response = await fetch(query_string);
const data = await response.text();
const root = parse(data);
// const entries = root.querySelectorAll('.csl-entry');

console.log(data);
const entries = JSON.parse(data);
// console.log(entries.length)
---

{
  entries.length > 0 ? (
    entries.map((e) => {

      // Convert to text on the fly and then linkyfy
      // https://github.com/Hypercontext/linkifyjs?tab=readme-ov-file
      let HTMLtext = linkifyHtml(e["bib"].toString(), options);

      // Parse the manipulated text again to HTML object
      let HTMLobj = parse(HTMLtext);

      try {
        // set border for entry
        let entry = HTMLobj.querySelector('.csl-entry');
        // console.log(entry)
        entry.classList.add('border-green-600');
        entry.classList.add('border-solid');
        entry.classList.add('border-l-8');
        entry.classList.add('pl-2');

      } catch {
        //
      }

      try {
        // Add Tailwind class for links
        let allLinks = HTMLobj.querySelectorAll('a');

        allLinks[allLinks.length - 1].setAttribute('class', 'underline');
        // // .setAttribute('target', '_blank');
      } finally {

        let entry = HTMLobj.querySelector('.csl-entry');
        return (
          <p
            class="mb-4"
            set:html={entry}
          />
        );
      }
    })
  ) : (
    <p>bisher noch keine Informationen an dieser Stelle</p>
  )
}

<style>
  a {
    color: red;
  }
  .csl-entry {
    border-left: 5px solid red;
  }
</style>
